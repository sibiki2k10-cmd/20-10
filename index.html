<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Link Saver üß†</title>
    <style>
        :root { --primary: #0984e3; --bg: #f5f6fa; --card: #fff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; }
        
        #login-screen { background: var(--card); padding: 40px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 50px; }
        .hidden { display: none; }
        
        /* Input Group */
        .input-group { background: var(--card); padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #dcdde1; border-radius: 6px; box-sizing: border-box; }
        
        /* URL Input Area (Flexbox ƒë·ªÉ ƒë·∫∑t n√∫t Get b√™n c·∫°nh) */
        .url-row { display: flex; gap: 5px; align-items: center; }
        .url-row input { flex: 1; } /* Chi·∫øm h·∫øt ch·ªó tr·ªëng */
        .btn-get { width: auto; padding: 12px; background: #6c5ce7; color: white; border: none; border-radius: 6px; cursor: pointer; }
        
        /* Main Button */
        .btn-save { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        /* Link Card N√¢ng cao */
        .link-card { background: var(--card); padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; gap: 15px; align-items: start; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .site-icon { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; margin-top: 5px;}
        .link-info { flex: 1; }
        .link-info h3 { margin: 0 0 5px 0; font-size: 1.1rem; color: #2d3436; }
        .desc { font-size: 0.85rem; color: #636e72; margin-bottom: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .tag { background: #dfe6e9; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; color: #2d3436; }
        .actions { display: flex; flex-direction: column; gap: 5px; }
        .btn-del { background: #fab1a0; color: #d63031; padding: 5px 10px; border-radius: 4px; cursor: pointer; border: none; font-size: 0.8rem; }
        .btn-open { text-decoration: none; background: #00b894; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; text-align: center;}
    </style>
</head>
<body>

    <div class="container">
        <div id="login-screen">
            <h2>üîê Smart Link Saver</h2>
            <input type="text" id="user" placeholder="Username">
            <input type="password" id="pass" placeholder="Password">
            <button class="btn-save" onclick="login()">ƒêƒÉng nh·∫≠p</button>
            <p id="msg" style="color:red; margin-top:10px"></p>
        </div>

        <div id="app" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span id="welcome-msg" style="font-weight:bold"></span>
                <a href="#" onclick="location.reload()" style="color:#636e72">Tho√°t</a>
            </div>

            <div class="input-group">
                <h3>Th√™m Link M·ªõi</h3>
                
                <div class="url-row">
                    <input type="url" id="linkUrl" placeholder="D√°n URL v√†o ƒë√¢y (https://...)" onchange="autoFetch()">
                    <button class="btn-get" onclick="autoFetch()">‚ö°</button>
                </div>
                
                <input type="text" id="linkTitle" placeholder="Ti√™u ƒë·ªÅ (T·ª± ƒë·ªông l·∫•y)">
                <input type="hidden" id="linkDesc">
                <input type="hidden" id="linkIcon">

                <select id="linkCategory">
                    <option value="C√¥ng vi·ªác">üíº C√¥ng vi·ªác</option>
                    <option value="H·ªçc t·∫≠p">üìö H·ªçc t·∫≠p</option>
                    <option value="Gi·∫£i tr√≠">üé¨ Gi·∫£i tr√≠</option>
                    <option value="Kh√°c">‚ú® Kh√°c</option>
                </select>
                <button class="btn-save" onclick="addLink()">üíæ L∆∞u Link</button>
                <p id="fetch-status" style="font-size:0.8rem; color:#0984e3; margin-top:5px;"></p>
            </div>

            <div id="link-list">Loading...</div>
        </div>
    </div>

    <script>
        // --- D√ÅN LINK SCRIPT V√ÄO ƒê√ÇY ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyHKJNDbK8-Fd9BnHFJRWE_PmXYtzdQz6NB171bPfazkxRGG9iSh-fy-akFyV5pQhud/exec'; 

        let currentUserMDD = "";

        // H√ÄM T·ª∞ ƒê·ªòNG L·∫§Y TH√îNG TIN
        function autoFetch() {
            const url = document.getElementById('linkUrl').value;
            const status = document.getElementById('fetch-status');
            
            if(!url.startsWith('http')) return; // Ch∆∞a nh·∫≠p link ƒë√∫ng th√¨ th√¥i
            
            status.innerText = "‚è≥ ƒêang ph√¢n t√≠ch trang web...";
            
            const fd = new FormData();
            fd.append('action', 'fetchMeta');
            fd.append('url', url);

            fetch(SCRIPT_URL, { method: 'POST', body: fd })
            .then(res => res.json())
            .then(data => {
                if(data.status == 'success') {
                    document.getElementById('linkTitle').value = data.title;
                    document.getElementById('linkDesc').value = data.description;
                    document.getElementById('linkIcon').value = data.icon;
                    status.innerText = "‚úÖ ƒê√£ l·∫•y th√¥ng tin th√†nh c√¥ng!";
                    setTimeout(() => status.innerText = "", 3000);
                } else {
                    status.innerText = "‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c t·ª± ƒë·ªông, h√£y nh·∫≠p tay.";
                }
            });
        }

        // H√ÄM ƒêƒÇNG NH·∫¨P
        function login() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            document.getElementById('msg').innerText = "ƒêang ki·ªÉm tra...";

            const fd = new FormData();
            fd.append('action', 'login');
            fd.append('user', u); fd.append('pass', p);

            fetch(SCRIPT_URL, { method: 'POST', body: fd })
            .then(res => res.json())
            .then(data => {
                if(data.status == 'success') {
                    currentUserMDD = data.mdd;
                    document.getElementById('welcome-msg').innerText = "Xin ch√†o, " + u;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    loadLinks();
                } else {
                    document.getElementById('msg').innerText = "Sai th√¥ng tin!";
                }
            });
        }

        // H√ÄM TH√äM LINK
        function addLink() {
            const title = document.getElementById('linkTitle').value;
            const url = document.getElementById('linkUrl').value;
            const cate = document.getElementById('linkCategory').value;
            // L·∫•y th√™m 2 th√¥ng tin ·∫©n
            const desc = document.getElementById('linkDesc').value;
            let icon = document.getElementById('linkIcon').value;

            if(!title || !url) return alert("Thi·∫øu URL ho·∫∑c Ti√™u ƒë·ªÅ");
            
            // N·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c icon t·ª± ƒë·ªông th√¨ d√πng icon m·∫∑c ƒë·ªãnh
            if(!icon) icon = "https://cdn-icons-png.flaticon.com/512/1006/1006771.png";

            const btn = document.querySelector('.btn-save');
            btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;

            const fd = new FormData();
            fd.append('action', 'addLink');
            fd.append('title', title);
            fd.append('url', url);
            fd.append('category', cate);
            fd.append('desc', desc);
            fd.append('icon', icon);
            fd.append('mdd', currentUserMDD);

            fetch(SCRIPT_URL, { method: 'POST', body: fd })
            .then(() => {
                // Reset form
                document.getElementById('linkUrl').value = "";
                document.getElementById('linkTitle').value = "";
                document.getElementById('linkDesc').value = "";
                document.getElementById('linkIcon').value = "";
                btn.innerText = "üíæ L∆∞u Link"; btn.disabled = false;
                loadLinks();
            });
        }

        // H√ÄM T·∫¢I DANH S√ÅCH
        function loadLinks() {
            fetch(SCRIPT_URL + '?action=getLinks&mdd=' + currentUserMDD)
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('link-list');
                list.innerHTML = "";
                if(data.length === 0) return list.innerHTML = "<p align='center'>Tr·ªëng tr∆°n.</p>";

                data.forEach(row => {
                    // C·∫•u tr√∫c tr·∫£ v·ªÅ: 
                    // [0]Time, [1]Title, [2]URL, [3]Cate, [4]Status, [5]MDD, [6]Desc, [7]Icon, [8]RowIndex
                    
                    const icon = row[7] || "https://cdn-icons-png.flaticon.com/512/1006/1006771.png";
                    const desc = row[6] || "Kh√¥ng c√≥ m√¥ t·∫£.";

                    list.innerHTML += `
                        <div class="link-card">
                            <img src="${icon}" class="site-icon" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1006/1006771.png'">
                            <div class="link-info">
                                <h3>${row[1]}</h3>
                                <div class="desc">${desc}</div>
                                <div style="margin-top:5px">
                                    <span class="tag">${row[3]}</span> 
                                    <span style="font-size:0.75rem; color:#aaa">${new Date(row[0]).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div class="actions">
                                <a href="${row[2]}" target="_blank" class="btn-open">M·ªü</a>
                                <button class="btn-del" onclick="deleteLink(${row[8]})">X√≥a</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        function deleteLink(idx) {
            if(confirm("X√≥a nh√©?")) {
                const fd = new FormData();
                fd.append('action', 'deleteLink');
                fd.append('row', idx);
                fetch(SCRIPT_URL, { method: 'POST', body: fd }).then(() => loadLinks());
            }
        }
    </script>

</body>
</html>

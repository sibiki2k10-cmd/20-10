<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Master Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4e54c8; --secondary: #8f94fb;
            --bg: #f4f7fc; --sidebar: #ffffff; --text: #333;
            --danger: #ff6b6b; --success: #2ecc71;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }
        
        /* LAYOUT */
        .sidebar { width: 250px; background: var(--sidebar); display: flex; flex-direction: column; padding: 20px; border-right: 1px solid #ddd; transition: 0.3s; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* LOGIN OVERLAY */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            z-index: 999; display: flex; align-items: center; justify-content: center;
        }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .inp-login { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        
        /* SIDEBAR ELEMENTS */
        .brand { font-size: 1.5rem; font-weight: bold; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; color: #666; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover, .menu-item.active { background: #eef2ff; color: var(--primary); font-weight: bold; }
        .user-info { margin-top: auto; padding-top: 20px; border-top: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; }

        /* TOP BAR */
        .top-bar { padding: 20px; background: white; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .search-box { position: relative; width: 300px; }
        .search-box input { width: 100%; padding: 10px 15px 10px 40px; border-radius: 20px; border: 1px solid #ddd; outline: none; background: #f9f9f9; }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }
        
        /* GRID & CARDS */
        .grid-container { padding: 20px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s; position: relative; border: 1px solid transparent; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--secondary); }
        .card-header { display: flex; gap: 10px; margin-bottom: 10px; }
        .card-icon { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .card-title { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        .card-cat { font-size: 0.75rem; background: #eee; padding: 2px 8px; border-radius: 4px; color: #666; }
        .card-desc { font-size: 0.85rem; color: #777; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.6em; }
        .card-actions { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f0f0f0; padding-top: 10px; }
        .btn-icon { background: none; border: none; cursor: pointer; color: #999; transition: 0.2s; }
        .btn-icon:hover { color: var(--primary); }
        .btn-icon.del:hover { color: var(--danger); }

        /* BUTTONS */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-primary { background: linear-gradient(to right, var(--primary), var(--secondary)); box-shadow: 0 4px 10px rgba(78, 84, 200, 0.3); }
        .btn-primary:hover { opacity: 0.9; }
        .fab-add { position: absolute; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; font-size: 24px; border: none; cursor: pointer; box-shadow: 0 5px 15px rgba(78, 84, 200, 0.4); display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .fab-add:hover { transform: scale(1.1) rotate(90deg); }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 500px; padding: 25px; border-radius: 12px; animation: slideIn 0.3s; }
        @keyframes slideIn { from {transform: translateY(-20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; }
        .modal-actions { text-align: right; margin-top: 20px; }
        .hidden { display: none !important; }

        /* TOAST */
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; opacity: 0; transition: 0.3s; pointer-events: none; }
        .toast-show { opacity: 1 !important; bottom: 50px !important; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -250px; height: 100%; z-index: 900; }
            .sidebar.open { left: 0; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
            .menu-toggle { display: block; font-size: 1.5rem; cursor: pointer; margin-right: 15px; }
        }
        @media (min-width: 769px) { .menu-toggle { display: none; } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color:var(--primary); margin:0 0 20px 0;"><i class="fas fa-link"></i> Link Master</h2>
            <input type="text" id="u" class="inp-login" placeholder="Tên đăng nhập">
            <input type="password" id="p" class="inp-login" placeholder="Mật khẩu">
            <button class="btn btn-primary" onclick="app.login()" style="width:100%; margin-top:10px">Đăng nhập</button>
            <p id="login-msg" style="color:red; font-size:0.8rem; margin-top:10px"></p>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="brand"><i class="fas fa-link"></i> Link Master</div>
        <div id="menu-list">
            <div class="menu-item active" onclick="app.filter('all', this)"><i class="fas fa-th-large"></i> Tất cả</div>
            <div class="menu-item" onclick="app.filter('Công việc', this)"><i class="fas fa-briefcase"></i> Công việc</div>
            <div class="menu-item" onclick="app.filter('Học tập', this)"><i class="fas fa-graduation-cap"></i> Học tập</div>
            <div class="menu-item" onclick="app.filter('Giải trí', this)"><i class="fas fa-film"></i> Giải trí</div>
            <div class="menu-item" onclick="app.filter('Tài liệu', this)"><i class="fas fa-folder-open"></i> Tài liệu</div>
            <div class="menu-item" onclick="app.filter('Khác', this)"><i class="fas fa-star"></i> Khác</div>
        </div>
        <div class="user-info">
            <span id="user-display">Guest</span>
            <button onclick="location.reload()" style="background:none; border:none; color:var(--danger); cursor:pointer"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div style="display:flex; align-items:center;">
                <i class="fas fa-bars menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')"></i>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-inp" placeholder="Tìm kiếm link..." onkeyup="app.search()">
                </div>
            </div>
            <button class="btn btn-primary" onclick="app.openModal()"><i class="fas fa-plus"></i> Thêm mới</button>
        </div>

        <div class="grid-container" id="grid">
            <p style="text-align:center; color:#999; width:100%">Đang tải dữ liệu...</p>
        </div>

        <button class="fab-add" onclick="app.openModal()"><i class="fas fa-plus"></i></button>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 id="modal-title">Thêm Link Mới</h3>
            
            <div class="form-group" style="display:flex; gap:5px">
                <input type="text" id="inp-url" class="form-control" placeholder="Dán URL vào đây (https://...)" onchange="app.fetchMeta()">
                <button onclick="app.fetchMeta()" class="btn" style="background:#eee; color:#333">⚡</button>
            </div>
            
            <div class="form-group">
                <input type="text" id="inp-title" class="form-control" placeholder="Tiêu đề website">
            </div>

            <div class="form-group">
                <select id="inp-cate" class="form-control">
                    <option value="Công việc">Công việc</option>
                    <option value="Học tập">Học tập</option>
                    <option value="Giải trí">Giải trí</option>
                    <option value="Tài liệu">Tài liệu</option>
                    <option value="Khác">Khác</option>
                </select>
            </div>

            <div class="form-group">
                <textarea id="inp-desc" class="form-control" rows="3" placeholder="Mô tả ngắn..."></textarea>
            </div>

            <input type="hidden" id="inp-icon">
            <input type="hidden" id="inp-row"> <div class="modal-actions">
                <button onclick="document.getElementById('modal').style.display='none'" class="btn" style="background:#eee; color:#333">Hủy</button>
                <button onclick="app.saveLink()" id="btn-save" class="btn btn-primary">Lưu lại</button>
            </div>
        </div>
    </div>

    <div id="toast">Thông báo</div>

    <script>
        // --- CẤU HÌNH ---
        // Thay link Script của bạn vào đây
        const API = 'https://script.google.com/macros/s/AKfycbwQm2Wz5o3mD-gXRDkd6basUQOKLV9CWTyh8EwteGkPiTzRF2jakzn_l2ML5AddvGlq/exec'; 

        const app = {
            data: [],
            userMDD: '',
            isEdit: false,

            login: function() {
                const u = document.getElementById('u').value;
                const p = document.getElementById('p').value;
                const btn = document.querySelector('.login-box button');
                const msg = document.getElementById('login-msg');

                btn.innerText = "Đang kiểm tra..."; btn.disabled = true;

                const fd = new FormData();
                fd.append('action', 'login'); fd.append('user', u); fd.append('pass', p);

                fetch(API, { method: 'POST', body: fd }).then(r => r.json()).then(res => {
                    if(res.status == 'success') {
                        this.userMDD = res.mdd;
                        document.getElementById('user-display').innerText = u;
                        document.getElementById('login-overlay').classList.add('hidden');
                        this.loadLinks();
                    } else {
                        msg.innerText = "Sai tài khoản hoặc mật khẩu!";
                        btn.innerText = "Đăng nhập"; btn.disabled = false;
                    }
                });
            },

            loadLinks: function() {
                fetch(API + '?action=getLinks&mdd=' + this.userMDD).then(r => r.json()).then(res => {
                    this.data = res;
                    this.render(this.data);
                });
            },

            render: function(list) {
                const grid = document.getElementById('grid');
                grid.innerHTML = "";
                if(list.length == 0) { grid.innerHTML = "<p style='width:100%; text-align:center'>Không có dữ liệu.</p>"; return; }

                list.forEach(item => {
                    // item: [0]Time, [1]Title, [2]Url, [3]Cate, [4]Status, [5]MDD, [6]Desc, [7]Icon, [8]RowIndex
                    const icon = item[7] || "https://www.google.com/s2/favicons?domain=google.com";
                    grid.innerHTML += `
                        <div class="card">
                            <div class="card-header">
                                <img src="${icon}" class="card-icon" onerror="this.src='https://via.placeholder.com/40'">
                                <div style="overflow:hidden;">
                                    <div class="card-title" title="${item[1]}">${item[1]}</div>
                                    <span class="card-cat">${item[3]}</span>
                                </div>
                            </div>
                            <div class="card-desc">${item[6]}</div>
                            <div class="card-actions">
                                <div>
                                    <a href="${item[2]}" target="_blank" class="btn-icon" title="Mở"><i class="fas fa-external-link-alt"></i></a>
                                    <button onclick="app.copyLink('${item[2]}')" class="btn-icon" title="Copy"><i class="fas fa-copy"></i></button>
                                </div>
                                <div>
                                    <button onclick="app.editModal(${item[8]})" class="btn-icon" title="Sửa"><i class="fas fa-pen"></i></button>
                                    <button onclick="app.deleteLink(${item[8]})" class="btn-icon del" title="Xóa"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            },

            filter: function(cate, el) {
                // Highlight active menu
                document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
                el.classList.add('active');
                
                // Filter logic
                if(cate == 'all') this.render(this.data);
                else {
                    const filtered = this.data.filter(x => x[3] == cate);
                    this.render(filtered);
                }
            },

            search: function() {
                const key = document.getElementById('search-inp').value.toLowerCase();
                const filtered = this.data.filter(x => 
                    String(x[1]).toLowerCase().includes(key) || 
                    String(x[2]).toLowerCase().includes(key) ||
                    String(x[6]).toLowerCase().includes(key)
                );
                this.render(filtered);
            },

            openModal: function() {
                this.isEdit = false;
                document.getElementById('modal-title').innerText = "Thêm Link Mới";
                document.getElementById('inp-url').value = "";
                document.getElementById('inp-title').value = "";
                document.getElementById('inp-desc').value = "";
                document.getElementById('inp-icon').value = "";
                document.getElementById('modal').style.display = 'flex';
            },

            editModal: function(rowIndex) {
                const item = this.data.find(x => x[8] == rowIndex);
                if(!item) return;

                this.isEdit = true;
                document.getElementById('modal-title').innerText = "Cập Nhật Link";
                document.getElementById('inp-row').value = rowIndex;
                document.getElementById('inp-title').value = item[1];
                document.getElementById('inp-url').value = item[2];
                document.getElementById('inp-cate').value = item[3];
                document.getElementById('inp-desc').value = item[6];
                document.getElementById('inp-icon').value = item[7];
                document.getElementById('modal').style.display = 'flex';
            },

            fetchMeta: function() {
                const url = document.getElementById('inp-url').value;
                if(url.length < 5) return;
                
                const btn = document.querySelector('.form-group button');
                btn.innerText = "⏳";
                
                const fd = new FormData();
                fd.append('action', 'fetchMeta'); fd.append('url', url);
                
                fetch(API, {method:'POST', body:fd}).then(r=>r.json()).then(res=>{
                    btn.innerText = "⚡";
                    if(res.status=='success'){
                        document.getElementById('inp-title').value = res.title;
                        document.getElementById('inp-desc').value = res.description;
                        document.getElementById('inp-icon').value = res.icon;
                        this.showToast("Đã lấy thông tin web!");
                    }
                });
            },

            saveLink: function() {
                const url = document.getElementById('inp-url').value;
                const title = document.getElementById('inp-title').value;
                const cate = document.getElementById('inp-cate').value;
                const desc = document.getElementById('inp-desc').value;
                const icon = document.getElementById('inp-icon').value || "https://www.google.com/s2/favicons?domain=google.com";
                const row = document.getElementById('inp-row').value;

                if(!url || !title) return alert("Cần nhập URL và Tiêu đề");

                const btn = document.getElementById('btn-save');
                btn.innerText = "Đang lưu..."; btn.disabled = true;

                const fd = new FormData();
                fd.append('mdd', this.userMDD);
                fd.append('url', url); fd.append('title', title);
                fd.append('category', cate); fd.append('desc', desc);
                fd.append('icon', icon);

                if(this.isEdit) {
                    fd.append('action', 'editLink');
                    fd.append('row', row);
                } else {
                    fd.append('action', 'addLink');
                }

                fetch(API, {method:'POST', body:fd}).then(r=>{
                    this.showToast(this.isEdit ? "Cập nhật thành công!" : "Đã thêm mới!");
                    document.getElementById('modal').style.display = 'none';
                    btn.innerText = "Lưu lại"; btn.disabled = false;
                    this.loadLinks();
                });
            },

            deleteLink: function(row) {
                if(!confirm("Xóa link này?")) return;
                const fd = new FormData();
                fd.append('action', 'deleteLink'); fd.append('row', row);
                
                // Optimistic UI update (Xóa ngay trên giao diện cho mượt)
                this.data = this.data.filter(x => x[8] != row);
                this.render(this.data);

                fetch(API, {method:'POST', body:fd});
                this.showToast("Đã xóa link");
            },

            copyLink: function(url) {
                navigator.clipboard.writeText(url);
                this.showToast("Đã copy link!");
            },

            showToast: function(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.classList.add('toast-show');
                setTimeout(()=>t.classList.remove('toast-show'), 3000);
            }
        };
    </script>
</body>
</html>

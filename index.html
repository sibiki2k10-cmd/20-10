<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Link Keeper üöÄ</title>
    <style>
        :root { --primary: #4a69bd; --bg: #f1f2f6; --text: #2f3542; --card: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 550px; }
        .hidden { display: none; }
        
        /* LOGIN SCREEN */
        #login-screen { background: var(--card); padding: 40px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 60px; }
        #login-screen h2 { color: var(--primary); margin-bottom: 20px; }
        
        /* INPUTS */
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #dfe4ea; border-radius: 8px; box-sizing: border-box; font-size: 14px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 5px rgba(74, 105, 189, 0.3); }
        
        /* BUTTONS */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: #3c5aa8; }
        .btn-get { width: 50px; background: #6a89cc; margin-left: 5px; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; padding: 0;}
        
        /* APP UI */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .add-box { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .url-row { display: flex; align-items: center; }
        
        /* LINK CARDS */
        .link-card { background: var(--card); border-radius: 10px; padding: 15px; margin-bottom: 15px; display: flex; gap: 15px; align-items: flex-start; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .link-card:hover { transform: translateY(-2px); }
        
        .site-icon { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; border: 1px solid #f1f2f6; flex-shrink: 0; }
        .link-content { flex: 1; overflow: hidden; }
        .link-title { font-weight: bold; font-size: 1rem; margin-bottom: 4px; color: #2f3542; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .link-desc { font-size: 0.8rem; color: #747d8c; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.4em; }
        .link-meta { display: flex; gap: 10px; font-size: 0.75rem; color: #a4b0be; }
        .category-tag { background: #dfe4ea; padding: 2px 8px; border-radius: 4px; color: #57606f; font-weight: 500; }
        
        .link-actions { display: flex; flex-direction: column; gap: 5px; }
        .btn-open { text-decoration: none; background: #2ecc71; color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; text-align: center; }
        .btn-del { background: #ff6b6b; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div class="container">
        <div id="login-screen">
            <h2>üîê KHO LINK C√Å NH√ÇN</h2>
            <input type="text" id="user" placeholder="T√™n ƒëƒÉng nh·∫≠p">
            <input type="password" id="pass" placeholder="M·∫≠t kh·∫©u">
            <button class="btn btn-primary" onclick="login()">ƒêƒÉng Nh·∫≠p</button>
            <p id="msg" style="color:#ff6b6b; margin-top:10px; font-size:0.9rem"></p>
        </div>

        <div id="app" class="hidden">
            <div class="header-bar">
                <div id="welcome-text" style="font-weight:bold; color: #57606f;">Hello!</div>
                <button onclick="location.reload()" style="background:none; border:1px solid #a4b0be; padding:5px 10px; border-radius:5px; cursor:pointer;">Tho√°t</button>
            </div>

            <div class="add-box">
                <h3 style="margin-top:0; color:var(--primary)">Th√™m Link M·ªõi</h3>
                <div class="url-row">
                    <input type="url" id="inpUrl" placeholder="D√°n link v√†o ƒë√¢y (https://...)" onchange="fetchInfo()">
                    <button class="btn btn-get" onclick="fetchInfo()">‚ö°</button>
                </div>
                <div id="status-text" style="font-size:0.8rem; color:#ffa502; margin-bottom:5px; height:15px"></div>

                <input type="text" id="inpTitle" placeholder="Ti√™u ƒë·ªÅ trang web">
                <input type="hidden" id="inpDesc">
                <input type="hidden" id="inpIcon">

                <select id="inpCate">
                    <option value="C√¥ng vi·ªác">üíº C√¥ng vi·ªác</option>
                    <option value="H·ªçc t·∫≠p">üìö H·ªçc t·∫≠p</option>
                    <option value="Gi·∫£i tr√≠">üé¨ Gi·∫£i tr√≠</option>
                    <option value="T√†i li·ªáu">üìÇ T√†i li·ªáu</option>
                    <option value="Kh√°c">‚ú® Kh√°c</option>
                </select>
                <button class="btn btn-primary" onclick="addLink()">L∆∞u v√†o kho</button>
            </div>

            <div id="list-container">
                <p style="text-align:center; color:#a4b0be">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH: D√ÅN LINK SCRIPT M·ªöI C·ª¶A B·∫†N V√ÄO ƒê√ÇY ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbxgLT3IE1FNjBFdc4ZwjXeQHZ-h3lVLCu9u3CwOUau4lHSsg7Tq0t2uZkXQMdQlJb1-/exec'; 

        let userMDD = "";

        // 1. ƒêƒÉng nh·∫≠p
        function login() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            const msg = document.getElementById('msg');
            msg.innerText = "ƒêang ki·ªÉm tra...";

            const fd = new FormData();
            fd.append('action', 'login');
            fd.append('user', u); fd.append('pass', p);

            fetch(API_URL, { method: 'POST', body: fd })
            .then(res => res.json())
            .then(data => {
                if(data.status == 'success') {
                    userMDD = data.mdd; // L∆∞u m√£ ƒë·ªãnh danh
                    document.getElementById('welcome-text').innerText = "Xin ch√†o, " + u;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    loadLinks();
                } else {
                    msg.innerText = "‚ùå Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u";
                }
            })
            .catch(err => msg.innerText = "‚ùå L·ªói k·∫øt n·ªëi Server");
        }

        // 2. T·ª± ƒë·ªông l·∫•y th√¥ng tin web
        function fetchInfo() {
            const url = document.getElementById('inpUrl').value;
            const status = document.getElementById('status-text');
            
            if(url.length < 5) return;
            status.innerText = "‚è≥ ƒêang ph√¢n t√≠ch...";
            status.style.color = "#ffa502";

            const fd = new FormData();
            fd.append('action', 'fetchMeta');
            fd.append('url', url);

            fetch(API_URL, { method: 'POST', body: fd })
            .then(res => res.json())
            .then(data => {
                if(data.status == 'success') {
                    document.getElementById('inpTitle').value = data.title;
                    document.getElementById('inpDesc').value = data.description;
                    document.getElementById('inpIcon').value = data.icon;
                    status.innerText = "‚úÖ ƒê√£ l·∫•y th√¥ng tin!";
                    status.style.color = "#2ecc71";
                } else {
                    status.innerText = "‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c t·ª± ƒë·ªông. H√£y nh·∫≠p tay.";
                    status.style.color = "#ff6b6b";
                    console.log(data.error); // Xem l·ªói chi ti·∫øt trong Console F12
                }
            })
            .catch(() => status.innerText = "‚ö†Ô∏è L·ªói m·∫°ng.");
        }

        // 3. Th√™m Link
        function addLink() {
            const url = document.getElementById('inpUrl').value;
            const title = document.getElementById('inpTitle').value;
            const cate = document.getElementById('inpCate').value;
            const desc = document.getElementById('inpDesc').value || "Kh√¥ng c√≥ m√¥ t·∫£";
            let icon = document.getElementById('inpIcon').value;

            if(!url || !title) return alert("Vui l√≤ng nh·∫≠p URL v√† Ti√™u ƒë·ªÅ");
            if(!icon) icon = "https://cdn-icons-png.flaticon.com/512/1006/1006771.png";

            const btn = document.querySelector('.add-box .btn-primary');
            btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;

            const fd = new FormData();
            fd.append('action', 'addLink');
            fd.append('mdd', userMDD); // Quan tr·ªçng
            fd.append('url', url);
            fd.append('title', title);
            fd.append('category', cate);
            fd.append('desc', desc);
            fd.append('icon', icon);

            fetch(API_URL, { method: 'POST', body: fd })
            .then(() => {
                alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
                // Reset form
                document.getElementById('inpUrl').value = "";
                document.getElementById('inpTitle').value = "";
                document.getElementById('status-text').innerText = "";
                btn.innerText = "L∆∞u v√†o kho"; btn.disabled = false;
                loadLinks();
            });
        }

        // 4. T·∫£i danh s√°ch
        function loadLinks() {
            fetch(API_URL + '?action=getLinks&mdd=' + userMDD)
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('list-container');
                list.innerHTML = "";
                
                if(data.length === 0) {
                    list.innerHTML = "<p style='text-align:center; color:#a4b0be'>Kho tr·ªëng. H√£y th√™m link ƒë·∫ßu ti√™n!</p>";
                    return;
                }

                data.forEach(row => {
                    // row: [0]Time, [1]Title, [2]URL, [3]Cate, [4]Status, [5]MDD, [6]Desc, [7]Icon, [8]RowIndex
                    const icon = row[7] || "https://cdn-icons-png.flaticon.com/512/1006/1006771.png";
                    
                    list.innerHTML += `
                        <div class="link-card">
                            <img src="${icon}" class="site-icon" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1006/1006771.png'">
                            <div class="link-content">
                                <div class="link-title" title="${row[1]}">${row[1]}</div>
                                <div class="link-desc">${row[6]}</div>
                                <div class="link-meta">
                                    <span class="category-tag">${row[3]}</span>
                                    <span>${new Date(row[0]).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div class="link-actions">
                                <a href="${row[2]}" target="_blank" class="btn-open">M·ªü ‚Üó</a>
                                <button class="btn-del" onclick="delLink(${row[8]})">X√≥a</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // 5. X√≥a Link
        function delLink(rowIndex) {
            if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn x√≥a link n√†y?")) {
                const fd = new FormData();
                fd.append('action', 'deleteLink');
                fd.append('row', rowIndex);
                fetch(API_URL, { method: 'POST', body: fd }).then(() => loadLinks());
            }
        }
    </script>
</body>
</html>
